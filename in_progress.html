<!DOCTYPE html>
<html lang="de-CH">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fishis</title>

    <style>
        #mCanvas{
            border: 1px solid #000;
            background-color: rgb(255, 255, 255);
            width:90%;
            height: 90%;
        }
    </style>
</head>

<body>
    <!-- Width und Height setzen hier die Canvas-Bildqualität fest -->
    <canvas id="mCanvas" width="1920" height="1080"></canvas>

    <!--- In progress Script -->
    <script>
//-------------------------------------------------------------------------------------------
//Klassen
//-------------------------------------------------------------------------------------------


        class Drawable{
            constructor(x, y, imgSprite, ctx){
                this.y = y;
                this.x = x;
                this.imgSprite = imgSprite;
                this.ctx = ctx;
            }

            draw(){
                this.ctx.drawImage(this.imgSprite, this.x, this.y);
            }

        }



        class Fish extends Drawable{

            //Variable direction ist negativ oder positiv
            //Direction:
            //-1 = links
            // 1 = rechts
            constructor(x, y, direction, imgSprite, ctx){
                super(x, y, imgSprite, ctx);
                //Speed ist in Pixel pro Sekunde
                this.speed = direction * 500;
                this.toDelete = false;
                this.direction = direction;

                //Indexe vom Fisch
                this.parentLayer = 0;

                //Debugging
                //console.log('Fisch erstellt.\nY: ' + y)
            }

            updatePositition(passedTimeSincePreviousFrame){

                //TODO: IF SHARK NEAR, SET direction to opposite side of shark


                this.x += (passedTimeSincePreviousFrame/1000) * this.speed;
                //TODO: IF OUTSIDE OF CANVAS, SET toDelete to true


                //Überprüfe, ob noch im Canvas
                if(((this.x < -64) || (this.x > 1920))){
                    this.toDelete = true;
                }

            }

            printStats(){
                console.log('X: '+this.x);
                console.log('Y: '+this.y);
                console.log('Direction: '+this.direction);
                console.log('IMG: '+this.imgSprite.src);
            }
        }

        
        class Layer extends Drawable{
            constructor(contentArray){
                super(0, 0, null, null);
                this.contentArray = contentArray;
            }
        }

//-------------------------------------------------------------------------------------------
//Variabeln
//-------------------------------------------------------------------------------------------
        
        //Canvas-Variabeln
        let canvas= document.getElementById('mCanvas');
        let ctx = canvas.getContext('2d');
        let gameFrame = 0;

        //Liste mit Fischbilder
        let fishImgSprites = new Array();

        //Liste mit Haibilder
        let sharkImgSprites = new Array();

        //Liste mit Szenerie-Layers
        let layers = new Array();

        for(let i=0; i<4; i++){
            layers.push(new Layer(new Array()));
        }

        let countImg = 0;
        //Variabeln um zu verhindern, dass ein Fisch während dem Zeichnen gespawnt/gelöscht wird
        let makeNewFish = false;
        //Ein 'Fisch-Müllkorb'
        let fishToDelete = new Array();

//-------------------------------------------------------------------------------------------
//Methoden
//-------------------------------------------------------------------------------------------
        
        //Funktion, die alle Bilder ladet, bevor sie gezeichnet werden
        function preloadImages(ctx){

            //Fischbilder laden
            for(let i=0; i<5; i++){
                let img = new Image();
                img.src = 'img/fish/'+ i +'.png';
                fishImgSprites.push(img);
            }

            console.log('All fish images are loaded');
            
            //Haibilder laden
            sharkImgSprites[0] = new Image();
            sharkImgSprites[0].src = 'img/shark/biting.png';
            sharkImgSprites[1] = new Image();
            sharkImgSprites[1].src = 'img/shark/normal.png';
            console.log('All shark images are loaded');

            //Durch jedes Layer-Listenelement iterieren und Bild hinzufügen
            for(let i=0; i<layers.length; i++){
                let img = new Image();

                //Beim laden checken, ob es das letzte Bild ist
                img.onload = function(){
                    if(++countImg == layers.length){
                        //Wenn alle Szenerie-Bilder geladen sind, werden sie gezeichnet
                        console.log('All scenery images are loaded');
                    }
                }
                img.src = 'img/z'+ i +'.png';
                layers[i].imgSprite = img;
                layers[i].ctx = ctx;
            }

        }

        //Diese Funktion erstellt einen zufälligen Fisch und fügt ihn in eine zufällige Layer ein
        function spawnFish(){
            
            //Generiere zufällig die Farbe. 5 Farben mit Wahrscheinlichkeit von 20%
            let fishImg = new Image();
            let randColor = Math.random();

            //Grün
            if(randColor < 0.2){
                fishImg = fishImgSprites[0];
            }
            //Orange
            if((randColor > 0.2) && (randColor < 0.4)){
                fishImg = fishImgSprites[1];
            }
            //Gelb
            if((randColor > 0.4) && (randColor < 0.6)){
                fishImg = fishImgSprites[2];
            }
            //Pink
            if((randColor > 0.6) && (randColor < 0.8)){
                fishImg = fishImgSprites[3];
            }
            //Blau
            if(randColor < 0.8){
                fishImg = fishImgSprites[4];
            }

            //Generiere zufällig Y-Position. 1060 = 1080px - Fisch-Höhe(64px)
            let y = Math.random() * 1016;
            
            //Bestimmt zufällig, in welche Layer der Fisch eingefügt werden sollte
            let randLayer = Math.random();
            let indexOfLayer = 0;
            let indexInContentArray = 0;

            if(randLayer < 0.25){
                indexOfLayer = 0;
            }
            if((randLayer > 0.25) && (randLayer < 0.5)){
                indexOfLayer = 1;
            }
            if((randLayer > 0.5) && (randLayer < 0.75)){
                indexOfLayer = 2;
            }
            if(randLayer > 0.75){
                indexOfLayer = 3;
            }

            //Bestimmt zufällig, ob von links/rechts gestartet werden sollte
            let fish;
            if(Math.random() < 0.5){
                //Startet rechts und schwimmt nach links
                fish = new Fish(1920, y, -1, fishImg, ctx);
            } else{
                //Startet links und schwimmt nach rechts
                fish = new Fish(-64, y, 1, fishImg, ctx);
            }

            //Fisch in die Layer einfügen
            layers[indexOfLayer].contentArray.push(fish);
            fish.parentLayer = indexOfLayer;
            console.log('Fish spawned in Layer '+ fish.parentLayer);


            //Debugging
            //console.log(JSON.stringify(layer.contentArray));

            //Sorgt dafür, dass nach 0.5s makeNewFish auf true gesetzt wird
            makeNewFish = false;
            delay(500).then(() => {makeNewFish = true;});
        }

        function delay(miliseconds){
            return new Promise(resolve => setTimeout(resolve, miliseconds));
        }

        function start(){
            spawnFish();

            //erster Animationsschritt
            window.requestAnimationFrame(function(actualTime){
                showFrame(actualTime, 0, 0);
            });
        }

        function getContentIndexOfFish(f) {    
            for (let i = 0; i < layers[f.parentLayer].contentArray.length; i++) {
                if (layers[f.parentLayer].contentArray[i] = f) {
                    return i;
                }
            }
            return -1;
        }

//-------------------------------------------------------------------------------------------
//Animation-Methode
//-------------------------------------------------------------------------------------------

        //Variable mit der verstrichenen Zeit ab letztem Frame in Milisekunden
        let previousFrameTime = 0;

        //Variable um lags zu erkennen
        let frameCount = 0;
        let fps = 0;

        function showFrame(actualTime, previousFrameTime, passedTimeSincePreviousFrame){
            
            //Alles leerfegen
            ctx.clearRect(0,0, canvas.width, canvas.height);

            passedTimeSincePreviousFrame = actualTime - previousFrameTime;
            previousFrameTime = actualTime;

            //Debugging: FPS
            //frameCount++;
            //console.log('Time since last Frame: ' + passedTimeSincePreviousFrame);

            //Erstellt neuen Fisch, wenn makeNewFish wahr ist
            //makeNewFish wird am Ende der Methode spawnFish() behandelt
            if(makeNewFish){
                spawnFish();
            }
            
            fishToDelete.forEach(function(fish, index){
                let fishContentIndex = getContentIndexOfFish(fish);
                layers[fish.parentLayer].contentArray.splice(fishContentIndex, 1);
                fishToDelete.splice(index, 1);
            });

            //Code um neues Frame zu erstellen           
            for(let i = 0; i<layers.length; i++){

                //1. Hintergrund der Ebene zeichnen
                layers[i].draw();

                //2. Iteriere durch Fisch-Liste der Ebene und aktualisiere/zeichne/lösche sie
                for(let j = 0; j<layers[i].contentArray.length; j++){

                    //Abchecken, ob Fisch gelöscht werden muss
                    let fish = layers[i].contentArray[j];
                    if(fish.toDelete){
                        fishToDelete.push(fish);
                    } else {
                        //Fischposition aktualisieren
                        fish.updatePositition(passedTimeSincePreviousFrame);
                        fish.draw();
                    }
                }
            }

            //nächster Animationsschritt (rekursiv)
            window.requestAnimationFrame(function(actualTime){
                showFrame(actualTime, previousFrameTime, passedTimeSincePreviousFrame);
            });
        }

//-------------------------------------------------------------------------------------------
//Events
//-------------------------------------------------------------------------------------------

        //Event beim laden des Dokuments
        window.onload = (event) => {
            preloadImages(ctx);
            start();
        }

    </script>
</body>

</html>